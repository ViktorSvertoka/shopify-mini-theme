<script src="{{ 'banner-product.js' | asset_url }}" defer></script>
{{ 'banner-product.css' | asset_url | stylesheet_tag }}

{%- liquid
  assign banner_product = nil
  
  if product
    assign banner_product = product
  elsif handle
    assign banner_product = all_products[handle]
  endif
-%}

{%- if banner_product == nil or banner_product == blank -%}
  <div class="">
    Product not found
  </div>
{%- else -%}

<div class="banner-product">
  {%- capture images_json -%}
    [
    {%- if banner_product.images != blank -%}
      {%- for image in banner_product.images -%}
        "{{ image | image_url: width: 800 }}"{% unless forloop.last %},{% endunless %}
      {%- endfor -%}
    {%- else -%}
      "{{ 'product-placeholder.jpg' | asset_url }}"
    {%- endif -%}
    ]
  {%- endcapture -%}

  <div class="banner-product__gallery" data-all-images='{{ images_json | strip_newlines }}'>
    <div class="banner-product__thumbs"></div>
    <div class="banner-product__main"></div>
  </div>

  <div class="banner-product__content">
    <h2 class="banner-product__title">
      {{ banner_product.title | escape }}
    </h2>

    {%- if banner_product.tags contains "Highly Rated" -%}
      <p class="banner-product__badge">
        <img 
          src="{{ 'icon-star.svg' | asset_url }}" 
          alt="Star" 
          class="badge__icon"
          width="16"
          height="16"
        >
        Highly Rated
      </p>
    {%- endif -%}

    {%- if banner_product.price != blank -%}
      <div class="banner-product__price">
        {%- if banner_product.compare_at_price > banner_product.price -%}
          <span class="price price--sale">{{ banner_product.price | money }}</span>
          <span class="price price--old">{{ banner_product.compare_at_price | money }}</span>
        {%- else -%}
          <span class="price">{{ banner_product.price | money }}</span>
        {%- endif -%}
      </div>
    {%- endif -%}

    {%- comment %} Find color option {% endcomment -%}
    {%- assign color_option_index = nil -%}
    {%- for option in banner_product.options_with_values -%}
      {%- assign opt_name = option.name | downcase -%}
      {%- if opt_name contains 'color' or opt_name contains 'colour' or opt_name contains 'цвет' -%}
        {%- assign color_option_index = forloop.index0 -%}
        {%- break -%}
      {%- endif -%}
    {%- endfor -%}

    {%- comment %} Render color buttons - one per unique color {% endcomment -%}
    {%- if color_option_index != nil -%}
      {%- assign unique_colors = banner_product.variants | map: 'option1' | uniq -%}
      {%- assign images_per_color = 5 -%}
      
      <div class="banner-product__colors">
        {%- for color in unique_colors -%}
          {%- comment %} Find first variant with this color {% endcomment -%}
          {%- assign color_variant = banner_product.variants | where: 'option1', color | first -%}
          
          {%- if color_variant -%}
            {%- assign color_index = forloop.index0 -%}
            {%- assign start_index = color_index | times: images_per_color -%}
            {%- assign end_index = start_index | plus: images_per_color | minus: 1 -%}
            
            {%- comment %} Get the image for this color (from variant or product images) {% endcomment -%}
            {%- if color_variant.image -%}
              {%- assign color_image = color_variant.image -%}
            {%- elsif banner_product.images[start_index] -%}
              {%- assign color_image = banner_product.images[start_index] -%}
            {%- else -%}
              {%- assign color_image = banner_product.featured_image -%}
            {%- endif -%}
            
            <button 
              type="button"
              class="banner-product__color-btn"
              data-start="{{ start_index }}"
              data-end="{{ end_index }}"
              data-price="{{ color_variant.price | money }}"
              data-compare="{{ color_variant.compare_at_price | money }}"
              data-available="{{ color_variant.available }}"
              data-qty="{{ color_variant.inventory_quantity }}"
              data-color="{{ color }}"
            >
              <img 
                src="{{ color_image | image_url: width: 60 }}" 
                alt="{{ color }}"
                width="60"
                height="60"
              >
            </button>
          {%- endif -%}
        {%- endfor -%}
      </div>

      <div 
        class="banner-product__stock"
        data-not-available="{{ 'products.product.banner.not_available' | t: default: 'Not available' }}"
        data-available-template="{{ 'products.product.banner.available_with_count' | t: count: '__COUNT__', default: 'Available: __COUNT__' }}"
      >
        {{ 'products.product.banner.select_color' | t: default: 'Choose a color' }}
      </div>
    {%- endif -%}

    <p class="banner-product__select-size">Select Size:</p>
    <div class="banner-product__sizes">
      {%- assign sizes = banner_product.variants | map: 'option2' | uniq -%}
      {%- for size in sizes -%}
        {%- assign variant = banner_product.variants | where: 'option2', size | first -%}
        {%- if variant -%}
          <button 
            type="button" 
            class="banner-product__size-btn"
            data-variant-id="{{ variant.id }}"
            data-available="{{ variant.available }}"
          >
            EU {{ size }}
          </button>
        {%- endif -%}
      {%- endfor -%}
    </div>

    {%- assign first_variant = banner_product.variants.first -%}
    <a 
      href="/cart/add?id={{ first_variant.id }}&quantity=1" 
      class="banner-product__add-to-cart"
    >
      Add To Bag
    </a>

    <div class="banner-product__description">
      {{ banner_product.description | truncatewords: 30, '...' }}
    </div>
  </div>
</div>

{%- endif -%}